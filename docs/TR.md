# Техническое решение

## Кратко основная идея реализации
Реализация нового сервиса для работы с функционалом TODO-листа.

## Изменяемые микросервисы или инфраструктурные сервисы
### Backend:
- Язык: JavaScript
- Фреймворк: Express.js
- БД: MySQL (удаленная работа на сервере преподавателя)
- ORM: mongoose

### Frontend:
- Технологии: HTML + CSS (статика)
- Скриптовый язык: JavaScript (статика для работы с сервером)

### Другие используемые технологии:
- nodemon — утилита для запуска сервера для разработки
- jsonwebtoken — утилита для работы с токенами
- argon2 — утилита для хеширования паролей
- helmet — утилита для установки HTTP-заголовков, связанных с безопасностью
- cors — утилита для установки HTTP-заголовков, связанных с CORS
- cross-env — утилита для установки переменных среды окружения

## Особенности деплоя(примерно)
В качестве удаленного сервера можно использовать любой VPS сервис.

Backend: Backend-сервер будет развернут на удаленном сервере с помощью платформы, такой как Heroku или AWS. Для управления зависимостями и деплоя используется npm или yarn.

Frontend: Статические файлы фронтенда будут размещены на CDN (Content Delivery Network) или развернуты на том же сервере, что и бэкенд. Для развертывания использоваться будет система контроля версий Git и автоматический деплой при коммите в основную ветку.



## Структура проекта (примерно)
- `config.example` - директория должна быть переименована в `config` после установки значений переменных. Обычно, переменные среды окружения помещаются в файл `.env`, но можно использовать и такой вариант, главное, не забыть указать `config` в `.gitignore`
- `index.js`
- `middlewares` - посредники, промежуточный слой
- `index.js` - агрегация и повторный экспорт посредников
- `setCookie.js` - для генерации токенов обновления и доступа
- `setSecurityHeaders.js` - для установки заголовков безопасности, используется вместо `helmet`
- `verifyAuth.js` - для проверки аутентификации
- `verifyAccess.js` - для проверки авторизации
- `verifyPermission.js` - для дополнительной проверки полномочий пользователя
- `models`
- `User.js` - модель пользователя для `mongoose`
- `routes`
- `app.routes.js` - роуты приложения
- `auth.routes.js` - роуты аутентификации/авторизации
- `services`
- `auth.services.js` - сервисы аутентификации/авторизации
- `utils` - утилиты
- `generateKeyPair.js` - для генерации публичного и приватного ключей (запускается при выполнении команды `yarn gen`)
- `token.js` - для подписания и проверки токенов
- `index.js` - основной файл сервера

## Роуты
- `api/`
  - `/auth`
    - `/` - получение данных аутентифицированного пользователя
    - `/register` - регистрация нового пользователя
    - `/login` - авторизация пользователя (вход в систему)
    - `/logout` - выход из системы
    - `/remove` - удаление пользователя
- `api/`
- `todo/`
  - `/tasks`
    - `/createTask`
    - `/deleteTask`

## Контракт взаимодействия с клиентами
## API Методы

| Метод            | Endpoint                           | Описание                        | Request                                                      | Response          | Errors                                       |
|------------------|------------------------------------|--------------------------------|--------------------------------------------------------------|-------------------|----------------------------------------------|
| Регистрация      | POST /api/auth/register            | Регистрация новой учетной записи | interface Request { email: string; password: string; }      | interface Response { message: string; } | ERR_EMAIL_ALREADY_EXISTS ERR_VALIDATION_FAILED |
| Авторизация      | POST /api/auth/login               | Вход пользователя в систему    | interface Request { email: string; password: string; }      | interface Response { token: string; } | ERR_INVALID_CREDENTIALS ERR_USER_NOT_FOUND |
| Создание задачи | POST /api/todo/:folderId/createTask               | Создание новой задачи          | interface Request { name: string; description?: string; date: Date; folderId?: string;} | interface Response {} | ERR_USER_NOT_AUTH ERR_VALIDATION_FAILED |
| Редактирование задачи | PUT /api/todo/:folderId/changeTask/:taskId    | Редактирование существующей задачи | interface Request { name?: string; description?: string; date: Date; folderId?: string; status:string} | interface Response {} | ERR_USER_NOT_AUTH ERR_TASK_NOT_FOUND ERR_VALIDATION_FAILED |
| Удаление задачи | DELETE /api/todo/:folderId/deleteTask:taskId    | Удаление существующей задачи  | -                                                            | interface Response {} | ERR_USER_NOT_AUTH ERR_TASK_NOT_FOUND |
| Создание папки  | POST /api/todo/folders/newFolder            | Создание новой папки            | interface Request { name: string; }                          | interface Response {} | ERR_USER_NOT_AUTH ERR_VALIDATION_FAILED |
| Редактирование папки | PUT /api/todo/folders/changeFolder:folderId | Редактирование существующей папки | interface Request { name: string; }                          | interface Response {} | ERR_USER_NOT_AUTH ERR_FOLDER_NOT_FOUND ERR_VALIDATION_FAILED |
| Удаление папки  | DELETE /api/todo/folders/deleteFolder:folderId | Удаление существующей папки   | -                                                            | interface Response {} | ERR_USER_NOT_AUTH ERR_FOLDER_NOT_FOUND |
| Получение задач по папке | GET /api/todo/folders/:folderId/tasks | Получение списка задач по указанной папке | -                                                    | interface Response { tasks: string; } | ERR_USER_NOT_AUTH ERR_FOLDER_NOT_FOUND |
| Сортировка задач | PUT /api/todo/tasks/sortTasks                | Получение отсортированного списка задач | Query Parameters: sortBy: string; // name или createdAt (по умолчанию) | interface Response { tasks: string; } | ERR_USER_NOT_AUTH |
| Получение списка папок | GET /api/todo/folders/allFolders               | Получение списка всех папок | - | interface Response { files: string; } | ERR_USER_NOT_AUTH ERR_FOLDER_NOT_FOUND |
| Просмотр задачи | GET /api/todo/folders/:folderId/tasks/:taskId               | Получение данных из задачи | - | interface Response { name: string; description: string; date: Date; folderId: string;} | ERR_USER_NOT_AUTH ERR_TASK_NOT_FOUND |


# Детальное описание ТР

Веб-приложение TODO-листа будет реализовано на основе предоставленного технического задания. Будет разработана структура базы данных MongoDB для хранения информации о пользователях, задачах и папках. Фронтенд будет представлен статическими HTML и CSS файлами, а взаимодействие с бэкендом будет осуществляться с помощью JavaScript. Авторизация пользователей будет осуществляться с помощью JWT токенов, отправка данных будет происходить через API с использованием HTTP методов.

## Регистрация

При регистрации на сервер отправляется POST-запрос по адресу /register. Тело запроса должно содержать имя, адрес электронной почты, пароль пользователя. Сервер проверяет наличие пользователя с указанным именем или email в БД. Если пользователь новый, его пароль хешируется, после чего данные пользователя записываются в БД и в req.user. После успешной записи пользователя в базу, сервер формирует и отправляет письмо на указанный при регистрации адрес электронной почты. Это письмо содержит ссылку для подтверждения, которая ведёт на конечную точку вроде /confirm-email с уникальным токеном (или кодом) для пользователя. Только после перехода по этой ссылке учетная запись пользователя считается полностью активированной.

## Авторизация

При инициализации клиентское приложение отправляет на сервер GET-запрос по адресу /api/auth/. Данный запрос проходит через посредника verifyAuth. Этот посредник проверяет 2 вещи:
- Наличие и значение специального заголовка X-Verification-Code. Вместо этого может использоваться любой другой способ уникальной идентификации запроса, позволяющий достоверно определить, что запрос отправлен доверенным клиентом

Если заголовок и токен в порядке, токен декодируется, его содержимое записывается в req.user и управление передается сервису getUser. Сервис getUser получает данные пользователя по его ID из БД, обновляет req.user.

Если время жизни токена обновления истекло, возвращается статус 401 и соответствующее сообщение. 

Токен обновления подписывается с помощью RS256 и содержит только ID пользователя. Время его жизни составляет 7 дней.

Токен доступа подписывается с помощью HS256 и содержит ID пользователя и его роль (role). Время его жизни составляет 1 час

При выполнении входа в систему на сервер отправляется POST-запрос по адресу /login. Тело запроса должно содержать email и пароль пользователя. Данные пользователя извлекаются из БД, пароли сравниваются.

При выполнении выхода из системы на сервер отправляется GET-запрос по адресу /logout. Данный запрос проходит через посредника verifyAccess.  Посредник verifyAccess проверяет наличие и время жизни токена доступа.


## Папки

Папка - представляет собой список для задач. Пользователь может создавать, редактировать и удалять папки для группировки своих задач. Каждая папка содержит список задач, которые могут быть отображены пользователю для удобства управления.

Пользователь может создать папку, чтобы группировать задачи по схожим критериям или тематикам. Например, папки могут быть организованы по проектам, приоритетам или срокам выполнения задач.

При удалении папки, все задачи, связанные с этой папкой, также будут удалены автоматически, чтобы сохранить целостность данных.

## Представление Задач

Задача - сущность, создаваемая пользователем для описания конкретной работы, которая должна быть выполнена. Каждая задача может иметь следующие поля:

- Название: Краткое описание задачи, которое позволяет пользователю легко определить ее суть.
- Описание: Дополнительная информация или инструкции, связанные с задачей, которые помогут пользователю более полно понять ее суть или требования.
- Дата создания: Дата и время, когда задача была создана в системе. Это поле автоматически устанавливается системой при создании задачи.
- Дата выполнения: Ожидаемая или фактическая дата, когда задача должна быть выполнена. Этот атрибут может быть опциональным, если задача не имеет конкретного срока выполнения.
- Статус выполнения: Показывает текущий статус задачи.

## Использованная Литература

- [Signup Login Application with Node.js, Express, and MySQL](https://medium.com/geekculture/signup-login-application-with-nodejs-express-and-mongodb-658498e580cf)
- [JWT: авторизация и аутентификация в приложениях Node.js](https://habr.com/ru/companies/timeweb/articles/593063/)
- [How to Build a Todo List App with JavaScript and Local Storage](https://thecodingpie.medium.com/how-to-build-a-todo-list-app-with-javascript-and-local-storage-a884f4ea3ec)
